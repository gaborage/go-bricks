openapi: 3.0.3
info:
  title: GoBricks Job Scheduler System API
  description: |
    System APIs for managing and triggering scheduled jobs in GoBricks applications.
    These endpoints are intended for operational use and are protected by CIDR-based IP allowlist.
  version: 1.0.0
  contact:
    name: GoBricks Framework
servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.example.com
    description: Production server

paths:
  /_sys/job:
    get:
      summary: List all registered jobs
      description: |
        Returns metadata for all registered jobs including schedule information, execution statistics,
        and next/last execution times. Returns empty array when no jobs are registered or scheduler not initialized.
      operationId: listJobs
      tags:
        - Job Management
      responses:
        '200':
          description: List of registered jobs (may be empty)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobListResponse'
              examples:
                with_jobs:
                  summary: Application with registered jobs
                  value:
                    data:
                      - jobId: cleanup-job
                        scheduleType: daily
                        cronExpression: "0 3 * * *"
                        humanReadable: "Daily at 3:00 AM"
                        nextExecutionTime: "2025-10-18T03:00:00Z"
                        lastExecutionTime: "2025-10-17T03:00:00Z"
                        lastExecutionStatus: success
                        totalExecutions: 42
                        successCount: 41
                        failureCount: 1
                        skippedCount: 0
                      - jobId: report-generator
                        scheduleType: weekly
                        cronExpression: "0 9 * * 1"
                        humanReadable: "Every Monday at 9:00 AM"
                        nextExecutionTime: "2025-10-20T09:00:00Z"
                        lastExecutionTime: "2025-10-13T09:00:00Z"
                        lastExecutionStatus: success
                        totalExecutions: 8
                        successCount: 8
                        failureCount: 0
                        skippedCount: 0
                    meta:
                      total: 2
                no_jobs:
                  summary: Application without registered jobs
                  value:
                    data: []
                    meta:
                      total: 0
        '403':
          description: Access denied - source IP not in CIDR allowlist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Access denied - IP not in allowlist"

  /_sys/job/{jobId}:
    post:
      summary: Manually trigger job execution
      description: |
        Triggers immediate execution of the specified job regardless of its schedule.
        The next scheduled execution time is not affected. Returns 409 if job is already running
        (overlapping execution prevention). Returns 404 if job doesn't exist or scheduler not initialized.
      operationId: triggerJob
      tags:
        - Job Management
      parameters:
        - name: jobId
          in: path
          required: true
          description: Unique identifier of the job to trigger
          schema:
            type: string
          example: cleanup-job
      responses:
        '200':
          description: Job triggered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TriggerJobResponse'
              example:
                data:
                  jobId: cleanup-job
                  triggered: true
                  scheduledNextAt: "2025-10-18T03:00:00Z"
                meta: {}
        '404':
          description: Job not found (invalid jobId or scheduler not initialized)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Job 'cleanup-job' not found"
        '409':
          description: Job already running (overlapping execution prevention)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Job 'cleanup-job' is already running. Trigger skipped."
        '403':
          description: Access denied - source IP not in CIDR allowlist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Access denied - IP not in allowlist"

components:
  schemas:
    JobMetadata:
      type: object
      description: Metadata about a registered job
      required:
        - jobId
        - scheduleType
        - cronExpression
        - humanReadable
        - totalExecutions
        - successCount
        - failureCount
        - skippedCount
      properties:
        jobId:
          type: string
          description: Unique identifier for the job
          example: cleanup-job
        scheduleType:
          type: string
          description: Type of schedule
          enum:
            - fixed-rate
            - daily
            - weekly
            - hourly
            - monthly
          example: daily
        cronExpression:
          type: string
          description: Cron-style representation of the schedule
          example: "0 3 * * *"
        humanReadable:
          type: string
          description: Human-readable schedule description
          example: "Daily at 3:00 AM"
        nextExecutionTime:
          type: string
          format: date-time
          nullable: true
          description: When the job will execute next (null if not yet scheduled)
          example: "2025-10-18T03:00:00Z"
        lastExecutionTime:
          type: string
          format: date-time
          nullable: true
          description: When the job last executed (null if never run)
          example: "2025-10-17T03:00:00Z"
        lastExecutionStatus:
          type: string
          nullable: true
          description: Status of last execution (null if never run)
          enum:
            - success
            - failure
            - skipped
          example: success
        totalExecutions:
          type: integer
          format: int64
          description: Total number of times job has been triggered (scheduled + manual)
          example: 42
        successCount:
          type: integer
          format: int64
          description: Number of successful executions
          example: 41
        failureCount:
          type: integer
          format: int64
          description: Number of failed executions (errors or panics)
          example: 1
        skippedCount:
          type: integer
          format: int64
          description: Number of triggers skipped due to already-running instance
          example: 0

    JobListResponse:
      type: object
      description: Response envelope for job list
      required:
        - data
        - meta
      properties:
        data:
          type: array
          description: Array of job metadata (empty if no jobs registered)
          items:
            $ref: '#/components/schemas/JobMetadata'
        meta:
          type: object
          required:
            - total
          properties:
            total:
              type: integer
              description: Total number of registered jobs
              example: 2

    TriggerJobResponse:
      type: object
      description: Response envelope for job trigger
      required:
        - data
        - meta
      properties:
        data:
          type: object
          required:
            - jobId
            - triggered
          properties:
            jobId:
              type: string
              description: ID of the triggered job
              example: cleanup-job
            triggered:
              type: boolean
              description: Whether the job was triggered (always true in 200 response)
              example: true
            scheduledNextAt:
              type: string
              format: date-time
              nullable: true
              description: Next scheduled execution time (unaffected by manual trigger)
              example: "2025-10-18T03:00:00Z"
        meta:
          type: object
          description: Response metadata (empty for this endpoint)

    ErrorResponse:
      type: object
      description: Error response
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
          example: "Job 'cleanup-job' not found"

tags:
  - name: Job Management
    description: Operations for managing and triggering scheduled jobs
